#!/bin/sh
set -eu
CFGDIR="$(mktemp -d)"
UUID=44444444-4444-4444-4444-444444444444
cat >"$CFGDIR/asbru.yml" <<YAML
---
__PAC__EXPORTED__FULL__: 1
defaults:
  debug: 1
  allow more instances: 1
  open connections in tabs: 1
  timeout connect: 8
  timeout command: 30
  save session logs: 0
  session logs folder: $CFGDIR/session_logs
  session logs amount: 5
  shell binary: /bin/bash
  shell directory: /tmp
  shell options: ''
  tabs in main window: 1
  version: 7.0.0
environments:
  $UUID:
    name: TestVNC
    title: TestVNC
    method: VNC
    ip: 127.0.0.1
    port: 5901
    user: test
    pass: testpass
    favourite: 0
    embed: 0
    description: Autogenerated VNC test entry
    cluster: []
    expect: []
    macros: []
    variables: []
    startup launch: 0
    startup script: 0
    terminal options:
      open in tab: 1
      timeout connect: 5
      timeout command: 20
      use personal settings: 0
  __PAC__ROOT__:
    children: {}
    expect: []
    pass: ''
    passphrase: ''
    screenshots: []
    variables: []
YAML
# Remove any stale freeze to force YAML load
rm -f "$CFGDIR/asbru.nfreeze"
# Run once; we only check that TigerVNC or RealVNC detection lines appear when verbose test diag enabled
ASBRU_TEST_VERBOSE=1 ASBRU_DISABLE_COSMIC=1 DBUS_SESSION_BUS_ADDRESS=unix:path=$CFGDIR/dummy-bus timeout 25 asbru-cm --config-dir="$CFGDIR" --no-splash --verbose --start-uuid=$UUID 2>&1 | grep -E 'TEST_DIAG:.*VNC_METHOD:(TigerVNC|RealVNC)' >/dev/null
# If grep failed, exit non-zero automatically due to set -e
exit 0
